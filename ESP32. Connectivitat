/*
  PROYECTO ESP32 - A09 Connectivitat
  Autor: [Anthony A. Rodrigues]
  Fecha: [09/12/2025]
 
  Este proyecto DEMUESTRA la conectividad WiFi del ESP32 usando:
  1. HTTP: Para obtener precio de Bitcoin desde API p煤blica
  2. NTP: Para obtener hora exacta desde servidor de tiempo
 
  Modificado para cumplir con la actividad A09 de Programaci贸n ESP32 Connectivitat
*/


#include <Adafruit_SSD1306.h>
#include <Wire.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "time.h"  // <-- AADIDO: Para funcionalidad NTP


// WiFi Configuration
const char* ssid = "Wokwi-GUEST";
const char* password = "";


// OLED Configuration
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);


// NTP Configuration - AADIDO para cumplir actividad
const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = 3600;      // GMT+1 para Espa帽a
const int daylightOffset_sec = 3600;  // Horario de verano


// API Configuration
const String url = "http://api.coindesk.com/v1/bpi/currentprice/BTC.json";
const String historyURL = "http://api.coindesk.com/v1/bpi/historical/close.json";


// Variables
HTTPClient http;
String lastPrice;
String currentTime = "";  // <-- AADIDO: Para almacenar hora NTP


// Icono Bitcoin
const unsigned char bitcoinIcon [] PROGMEM = {
0x00, 0x7e, 0x00, 0x03, 0xff, 0xc0, 0x07, 0x81, 0xe0, 0x0e, 0x00, 0x70, 0x18, 0x28, 0x18, 0x30,
0x28, 0x0c, 0x70, 0xfc, 0x0e, 0x60, 0xfe, 0x06, 0x60, 0xc7, 0x06, 0xc0, 0xc3, 0x03, 0xc0, 0xc7,
0x03, 0xc0, 0xfe, 0x03, 0xc0, 0xff, 0x03, 0xc0, 0xc3, 0x83, 0xc0, 0xc1, 0x83, 0x60, 0xc3, 0x86,
0x60, 0xff, 0x06, 0x70, 0xfe, 0x0e, 0x30, 0x28, 0x0c, 0x18, 0x28, 0x18, 0x0e, 0x00, 0x70, 0x07,
0x81, 0xe0, 0x03, 0xff, 0xc0, 0x00, 0x7e, 0x00
};


// Funci贸n para actualizar hora NTP - AADIDA
void updateNTPTime() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    Serial.println("Fallo al obtener hora NTP");
    currentTime = "NTP Error";
    return;
  }
 
  char timeStringBuff[20];
  strftime(timeStringBuff, sizeof(timeStringBuff), "%H:%M:%S", &timeinfo);
  currentTime = String(timeStringBuff);
  Serial.print(" Hora NTP actualizada: ");
  Serial.println(currentTime);
}


// Funci贸n para mostrar estado inicial - MODIFICADA
void mostrarEstadoInicial() {
  display.clearDisplay();
  display.setTextSize(1);
 
  // Mostrar conexi贸n WiFi
  display.setCursor(0, 0);
  display.print("WiFi: ");
  display.println(WiFi.SSID());
 
  display.setCursor(0, 10);
  display.print("IP: ");
  display.println(WiFi.localIP());
 
  // Mostrar que usa NTP - AADIDO
  display.setCursor(0, 20);
  display.print("NTP: ");
  display.println(ntpServer);
 
  // Mostrar que usa HTTP - AADIDO
  display.setCursor(0, 30);
  display.print("API: coindesk.com");
 
  display.setCursor(0, 45);
  display.print("A09 Connectivitat");
  display.setCursor(0, 55);
  display.print("ESP32 WiFi Demo");
 
  display.display();
  delay(3000);
}


void setup() {
  Serial.begin(115200);
  Serial.println("\n=== PROYECTO A09 ESP32 CONNECTIVITAT ===");
  Serial.println("Inicializando...");


  // Inicializar OLED
  if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
    Serial.println(F("Error OLED"));
    for (;;);
  }


  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
 
  // Pantalla de inicio
  display.setCursor(0, 0);
  display.println("A09 Connectivitat");
  display.println("Conectando WiFi...");
  display.println("SSID: Wokwi-GUEST");
  display.display();


  // Conectar WiFi
  WiFi.begin(ssid, password);
  int intentos = 0;
  while (WiFi.status() != WL_CONNECTED && intentos < 20) {
    delay(500);
    Serial.print(".");
    intentos++;
  }


  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n WiFi CONECTADO");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
   
    // Configurar NTP - AADIDO
    Serial.println("Configurando NTP...");
    configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
   
    // Obtener hora NTP inicial
    updateNTPTime();
   
    // Mostrar estado inicial
    mostrarEstadoInicial();
   
  } else {
    Serial.println("\nError WiFi");
    display.clearDisplay();
    display.setCursor(0, 0);
    display.println("Error WiFi");
    display.display();
    while(1);
  }
}


void loop() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi desconectado");
    display.clearDisplay();
    display.setCursor(0, 0);
    display.println("Reconectando...");
    display.display();
    WiFi.reconnect();
    delay(5000);
    return;
  }


  // Actualizar hora NTP cada ciclo - AADIDO
  updateNTPTime();
 
  // Obtener datos Bitcoin via HTTP
  obtenerDatosBitcoin();
 
  // Mostrar informaci贸n combinada - MODIFICADO
  mostrarInformacionCompleta();
 
  delay(10000); // Esperar 10 segundos
}


void obtenerDatosBitcoin() {
  Serial.println("\n--- Realizando petici贸n HTTP ---");
  Serial.print(" URL: ");
  Serial.println(url);
 
  http.begin(url);
  int httpCode = http.GET();
  Serial.print("C贸digo HTTP: ");
  Serial.println(httpCode);
 
  if (httpCode > 0) {
    String payload = http.getString();
   
    // Analizar JSON
    StaticJsonDocument<768> doc;
    DeserializationError error = deserializeJson(doc, payload);
   
    if (error) {
      Serial.print("Error JSON: ");
      Serial.println(error.f_str());
      http.end();
      return;
    }
   
    // Obtener precio
    String BTCUSDPrice = doc["bpi"]["USD"]["rate_float"].as<String>();
   
    if (BTCUSDPrice != lastPrice) {
      Serial.print("Precio BTC: $");
      Serial.println(BTCUSDPrice);
      lastPrice = BTCUSDPrice;
    }
   
    http.end();
  } else {
    Serial.print("Error HTTP: ");
    Serial.println(http.errorToString(httpCode).c_str());
  }
}


void mostrarInformacionCompleta() {
  display.clearDisplay();
 
  // Icono Bitcoin
  display.drawBitmap((128/2) - (24/2), 0, bitcoinIcon, 24, 24, WHITE);
 
  // Precio Bitcoin
  display.setTextSize(1);
  printCenter("BTC: $" + lastPrice, 0, 32);
 
  // Mostrar hora NTP - AADIDO
  display.setTextSize(1);
  printCenter("Hora: " + currentTime, 0, 45);
 
  // Estado WiFi
  display.setTextSize(1);
  display.setCursor(0, 55);
  display.print("WiFi: ");
  display.print(WiFi.RSSI());
  display.print("dBm");
 
  display.display();
 
  // Log en serial
  Serial.println("Informaci贸n mostrada en OLED:");
  Serial.print("  - BTC: $");
  Serial.println(lastPrice);
  Serial.print("  - Hora NTP: ");
  Serial.println(currentTime);
  Serial.print("  - WiFi RSSI: ");
  Serial.print(WiFi.RSSI());
  Serial.println(" dBm");
}


void printCenter(const String buf, int x, int y) {
  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(buf, x, y, &x1, &y1, &w, &h);
  display.setCursor((x - w / 2) + (128 / 2), y);
  display.print(buf);
}
